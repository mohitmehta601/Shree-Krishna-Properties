<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Auth Debug Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üõ†Ô∏è Supabase Auth Debug Tool</h1>
    <p>This tool will help debug your Supabase authentication issues.</p>

    <div class="test-section">
        <h2>üîç Step 1: Test Basic Connection</h2>
        <button onclick="testConnection()">Test Connection</button>
        <div id="connection-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üöÄ Step 2: Test Auth Endpoint Directly</h2>
        <button onclick="testAuthEndpoint()">Test Auth Endpoint</button>
        <div id="auth-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìß Step 3: Test User Signup</h2>
        <input type="email" id="test-email" placeholder="test@example.com" value="test@example.com">
        <input type="password" id="test-password" placeholder="password123" value="password123">
        <button onclick="testSignup()">Test Signup</button>
        <div id="signup-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üîß Step 4: Configuration Check</h2>
        <button onclick="checkConfig()">Check Configuration</button>
        <div id="config-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìã Troubleshooting Checklist</h2>
        <div id="checklist">
            <p>Based on your tests, verify these settings in your Supabase Dashboard:</p>
            <ul>
                <li>‚úÖ Go to Authentication ‚Üí Providers ‚Üí Email</li>
                <li>‚úÖ "Enable Email provider" is ON</li>
                <li>‚ùå "Confirm email" should be OFF (disabled) for development</li>
                <li>‚úÖ Go to Authentication ‚Üí Settings</li>
                <li>‚úÖ "Allow new users to sign up" is ON</li>
                <li>‚úÖ Go to Authentication ‚Üí URL Configuration</li>
                <li>‚úÖ Site URL: http://localhost:5173</li>
                <li>‚úÖ Redirect URLs: http://localhost:5173/**</li>
            </ul>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        
        const supabaseUrl = 'https://wqdrmjrxncpszekxhrhc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxZHJtanJ4bmNwc3pla3hocmhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDM5NjUsImV4cCI6MjA3NTkxOTk2NX0.fSRpemNa-dQT0ZJijp6yoKuMZnaMRIeeILghe0HpcAg';
        
        const client = createClient(supabaseUrl, supabaseKey);
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }
        
        async function testConnection() {
            const resultId = 'connection-result';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, 'üîç Testing basic Supabase connection...', 'info');
            
            try {
                // Test REST API
                const response = await fetch(`${supabaseUrl}/rest/v1/`, {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                });
                
                if (response.ok) {
                    log(resultId, '‚úÖ REST API connection: SUCCESS', 'success');
                } else {
                    log(resultId, `‚ùå REST API connection: FAILED (${response.status})`, 'error');
                }
                
                // Test auth session
                const { data, error } = await client.auth.getSession();
                if (error) {
                    log(resultId, `‚ö†Ô∏è Auth session test: ${error.message}`, 'warning');
                } else {
                    log(resultId, '‚úÖ Auth session: SUCCESS', 'success');
                }
                
            } catch (error) {
                log(resultId, `‚ùå Connection test failed: ${error.message}`, 'error');
            }
        }
        
        async function testAuthEndpoint() {
            const resultId = 'auth-result';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, 'üöÄ Testing auth endpoint directly...', 'info');
            
            try {
                const response = await fetch(`${supabaseUrl}/auth/v1/signup`, {
                    method: 'POST',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'direct-test@example.com',
                        password: 'testpass123'
                    })
                });
                
                const result = await response.text();
                
                log(resultId, `Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(resultId, `Response: ${result}`, 'info');
                
                if (response.status === 403) {
                    log(resultId, '‚ùå 403 FORBIDDEN: This confirms email confirmation is likely enabled', 'error');
                    log(resultId, 'üí° Solution: Disable "Confirm email" in Supabase Dashboard', 'warning');
                } else if (response.status === 422) {
                    log(resultId, '‚úÖ Endpoint is accessible (validation error is expected)', 'success');
                } else if (response.ok) {
                    log(resultId, '‚úÖ Direct auth test: SUCCESS', 'success');
                }
                
            } catch (error) {
                log(resultId, `‚ùå Direct auth test failed: ${error.message}`, 'error');
                if (error.message.includes('CORS')) {
                    log(resultId, 'üîß CORS Error detected - check Supabase URL configuration', 'warning');
                }
            }
        }
        
        async function testSignup() {
            const resultId = 'signup-result';
            document.getElementById(resultId).innerHTML = '';
            
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            if (!email || !password) {
                log(resultId, '‚ùå Please enter email and password', 'error');
                return;
            }
            
            log(resultId, `üìß Testing signup with: ${email}`, 'info');
            
            try {
                const { data, error } = await client.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (error) {
                    log(resultId, `‚ùå Signup failed: ${error.message}`, 'error');
                    
                    if (error.message.includes('Email not confirmed')) {
                        log(resultId, 'üí° Fix: Disable "Confirm email" in Supabase Dashboard', 'warning');
                    } else if (error.message.includes('User already registered')) {
                        log(resultId, 'üí° User exists - try with different email', 'warning');
                    } else if (error.message.includes('fetch')) {
                        log(resultId, 'üí° Connection issue - check dashboard settings', 'warning');
                    }
                } else {
                    log(resultId, '‚úÖ Signup successful!', 'success');
                    log(resultId, `User ID: ${data.user?.id}`, 'info');
                    log(resultId, `Email confirmed: ${data.user?.email_confirmed_at ? 'Yes' : 'No'}`, 'info');
                    
                    if (!data.user?.email_confirmed_at) {
                        log(resultId, 'üí° Email not confirmed - this is expected in development', 'warning');
                    }
                }
                
            } catch (error) {
                log(resultId, `‚ùå Signup error: ${error.message}`, 'error');
            }
        }
        
        function checkConfig() {
            const resultId = 'config-result';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, 'üîß Configuration check:', 'info');
            log(resultId, `Supabase URL: ${supabaseUrl}`, 'info');
            log(resultId, `Current origin: ${window.location.origin}`, 'info');
            log(resultId, `Anon key length: ${supabaseKey.length} chars`, 'info');
            
            log(resultId, '\nüìã Required Supabase Dashboard Settings:', 'info');
            log(resultId, '1. Authentication ‚Üí Providers ‚Üí Email:', 'info');
            log(resultId, '   ‚úÖ Enable Email provider: ON', 'info');
            log(resultId, '   ‚ùå Confirm email: OFF (CRITICAL for development)', 'error');
            log(resultId, '\n2. Authentication ‚Üí Settings:', 'info');
            log(resultId, '   ‚úÖ Allow new users to sign up: ON', 'info');
            log(resultId, '\n3. Authentication ‚Üí URL Configuration:', 'info');
            log(resultId, '   ‚úÖ Site URL: http://localhost:5173', 'info');
            log(resultId, '   ‚úÖ Redirect URLs: http://localhost:5173/**', 'info');
            
            log(resultId, '\nüö® Most Common Issue: "Confirm email" is ENABLED', 'error');
            log(resultId, 'üí° Solution: Go to Supabase Dashboard and DISABLE "Confirm email"', 'warning');
        }
        
        // Auto-run connection test on load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>